<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Active Directory & Azure T2R Generator</title>
    
    <!-- Fixed Libraries - Using working versions -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docx/7.8.2/docx.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0078d4 0%, #106ebe 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #0078d4 0%, #106ebe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .form-container {
            padding: 40px;
        }

        .section {
            margin-bottom: 40px;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 30px;
            border-left: 5px solid #0078d4;
        }

        .section h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.5em;
            display: flex;
            align-items: center;
        }

        .section h2::before {
            content: '';
            width: 6px;
            height: 6px;
            background: #0078d4;
            border-radius: 50%;
            margin-right: 15px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-row.triple {
            grid-template-columns: 1fr 1fr 1fr;
        }

        .form-row.single {
            grid-template-columns: 1fr;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #34495e;
        }

        input[type="text"],
        input[type="email"],
        input[type="tel"],
        input[type="number"],
        input[type="url"],
        input[type="date"],
        textarea,
        select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: white;
        }

        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: #0078d4;
            box-shadow: 0 0 0 3px rgba(0, 120, 212, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        .textarea-large {
            min-height: 150px;
        }

        /* Interactive Table Styles */
        .interactive-table {
            border: 2px solid #e9ecef;
            border-radius: 8px;
            margin-top: 10px;
            overflow: hidden;
            background: white;
        }

        .table-container {
            overflow-x: auto;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 600px;
        }

        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
            vertical-align: top;
        }

        .data-table th {
            background: #0078d4;
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        .data-table input,
        .data-table select,
        .data-table textarea {
            border: 1px solid #ddd;
            padding: 8px;
            margin: 0;
            border-radius: 4px;
            width: 100%;
            min-width: 120px;
        }

        .data-table textarea {
            min-height: 60px;
            resize: vertical;
        }

        .btn-remove {
            background: #dc3545;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }

        .btn-add {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }

        .btn-add:hover,
        .btn-remove:hover {
            opacity: 0.8;
        }

        .download-options {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin: 20px 0;
        }

        .download-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .download-btn:hover {
            background: #218838;
            transform: translateY(-1px);
        }

        .download-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .status-message {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #c3e6cb;
            display: none;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #f5c6cb;
            display: none;
        }

        .azure-integration {
            background: linear-gradient(135deg, #0078d4 0%, #40e0d0 100%);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }

        @media (max-width: 768px) {
            .form-row,
            .form-row.triple {
                grid-template-columns: 1fr;
            }
            
            .container {
                margin: 10px;
            }
            
            .form-container {
                padding: 20px;
            }

            .download-options {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Active Directory & Azure T2R Generator</h1>
            <p>Comprehensive Transition to Runbook Documentation for AD/Azure Environments</p>
        </div>

        <div class="form-container">
            <div class="status-message" id="statusMessage"></div>
            <div class="error-message" id="errorMessage"></div>

            <form id="t2rForm">
                <!-- Section A: Service Overview & Business Context -->
                <div class="section">
                    <h2>A. Service Overview & Business Context</h2>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="serviceName">Service Name *</label>
                            <input type="text" id="serviceName" name="serviceName" required placeholder="e.g., Corporate Active Directory">
                        </div>
                        <div class="form-group">
                            <label for="serviceVersion">Service Version</label>
                            <input type="text" id="serviceVersion" name="serviceVersion" placeholder="e.g., Windows Server 2022">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="environment">Environment</label>
                            <select id="environment" name="environment">
                                <option value="">Select Environment</option>
                                <option value="hybrid">Hybrid (On-Premises + Azure)</option>
                                <option value="azure-only">Azure Only</option>
                                <option value="on-premises">On-Premises Only</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="userCount">Total User Count</label>
                            <input type="number" id="userCount" name="userCount" placeholder="e.g., 5000">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="serviceDescription">Service Description *</label>
                        <textarea id="serviceDescription" name="serviceDescription" class="textarea-large" 
                                placeholder="Describe the AD/Azure environment, its purpose, and business function..." required></textarea>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="businessOwner">Business Owner *</label>
                            <input type="text" id="businessOwner" name="businessOwner" required>
                        </div>
                        <div class="form-group">
                            <label for="technicalOwner">Technical Owner *</label>
                            <input type="text" id="technicalOwner" name="technicalOwner" required>
                        </div>
                    </div>

                    <!-- SLA/KPI Interactive Table -->
                    <div class="form-group">
                        <label>Service Level Agreements (SLAs) & Key Performance Indicators (KPIs)</label>
                        <div class="interactive-table">
                            <div class="table-container">
                                <table class="data-table" id="slaKpiTable">
                                    <thead>
                                        <tr>
                                            <th>Metric</th>
                                            <th>Target Value</th>
                                            <th>Measurement Method</th>
                                            <th>Frequency</th>
                                            <th>Owner</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="slaKpiTableBody">
                                        <tr>
                                            <td><input type="text" placeholder="e.g., Uptime" name="slaMetric[]"></td>
                                            <td><input type="text" placeholder="e.g., 99.9%" name="slaTarget[]"></td>
                                            <td><input type="text" placeholder="e.g., Azure Monitor" name="slaMeasurement[]"></td>
                                            <td>
                                                <select name="slaFrequency[]">
                                                    <option value="">Select</option>
                                                    <option value="real-time">Real-time</option>
                                                    <option value="hourly">Hourly</option>
                                                    <option value="daily">Daily</option>
                                                    <option value="weekly">Weekly</option>
                                                    <option value="monthly">Monthly</option>
                                                </select>
                                            </td>
                                            <td><input type="text" placeholder="Team/Person" name="slaOwner[]"></td>
                                            <td><button type="button" class="btn-remove" onclick="removeTableRow(this)">Remove</button></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <button type="button" class="btn-add" onclick="addSlaKpiRow()">Add SLA/KPI</button>
                    </div>

                    <!-- RACI Matrix Interactive Table -->
                    <div class="form-group">
                        <label>RACI Matrix - Role Assignments</label>
                        <div class="interactive-table">
                            <div class="table-container">
                                <table class="data-table" id="raciTable">
                                    <thead>
                                        <tr>
                                            <th>Activity/Process</th>
                                            <th>Team Member</th>
                                            <th>Role</th>
                                            <th>Contact Info</th>
                                            <th>Backup</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="raciTableBody">
                                        <tr>
                                            <td><input type="text" placeholder="e.g., Password Reset" name="raciActivity[]"></td>
                                            <td><input type="text" placeholder="John Doe" name="raciPerson[]"></td>
                                            <td>
                                                <select name="raciRole[]">
                                                    <option value="">Select</option>
                                                    <option value="R">Responsible</option>
                                                    <option value="A">Accountable</option>
                                                    <option value="C">Consulted</option>
                                                    <option value="I">Informed</option>
                                                </select>
                                            </td>
                                            <td><input type="text" placeholder="email@company.com" name="raciContact[]"></td>
                                            <td><input type="text" placeholder="Backup person" name="raciBackup[]"></td>
                                            <td><button type="button" class="btn-remove" onclick="removeTableRow(this)">Remove</button></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <button type="button" class="btn-add" onclick="addRaciRow()">Add RACI Entry</button>
                    </div>
                </div>

                <!-- Section B: Architectural Overview -->
                <div class="section">
                    <h2>B. Architectural Overview</h2>
                    
                    <!-- System Architecture Table -->
                    <div class="form-group">
                        <label>High-Level Architecture Components</label>
                        <div class="interactive-table">
                            <div class="table-container">
                                <table class="data-table" id="architectureTable">
                                    <thead>
                                        <tr>
                                            <th>Component Type</th>
                                            <th>Server/Service Name</th>
                                            <th>Role</th>
                                            <th>IP Address/FQDN</th>
                                            <th>OS/Version</th>
                                            <th>Location</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="architectureTableBody">
                                        <tr>
                                            <td>
                                                <select name="archComponent[]">
                                                    <option value="">Select</option>
                                                    <option value="domain-controller">Domain Controller</option>
                                                    <option value="adfs">ADFS Server</option>
                                                    <option value="aad-connect">AAD Connect</option>
                                                    <option value="dns">DNS Server</option>
                                                    <option value="dhcp">DHCP Server</option>
                                                    <option value="ca">Certificate Authority</option>
                                                    <option value="nps">Network Policy Server</option>
                                                    <option value="other">Other</option>
                                                </select>
                                            </td>
                                            <td><input type="text" placeholder="Server name" name="archServer[]"></td>
                                            <td><input type="text" placeholder="Primary/Secondary" name="archRole[]"></td>
                                            <td><input type="text" placeholder="IP or FQDN" name="archAddress[]"></td>
                                            <td><input type="text" placeholder="Windows Server 2022" name="archOS[]"></td>
                                            <td><input type="text" placeholder="Data Center/Azure Region" name="archLocation[]"></td>
                                            <td><button type="button" class="btn-remove" onclick="removeTableRow(this)">Remove</button></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <button type="button" class="btn-add" onclick="addArchitectureRow()">Add Architecture Component</button>
                    </div>

                    <!-- Dependency Map -->
                    <div class="form-group">
                        <label>System Dependencies</label>
                        <div class="interactive-table">
                            <div class="table-container">
                                <table class="data-table" id="dependencyTable">
                                    <thead>
                                        <tr>
                                            <th>Dependency Type</th>
                                            <th>System/Service Name</th>
                                            <th>Dependency Description</th>
                                            <th>Impact if Unavailable</th>
                                            <th>Contact/Owner</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="dependencyTableBody">
                                        <tr>
                                            <td>
                                                <select name="depType[]">
                                                    <option value="">Select</option>
                                                    <option value="upstream">Upstream Dependency</option>
                                                    <option value="downstream">Downstream Consumer</option>
                                                    <option value="shared">Shared Service</option>
                                                    <option value="external">External Service</option>
                                                </select>
                                            </td>
                                            <td><input type="text" placeholder="System name" name="depSystem[]"></td>
                                            <td><textarea placeholder="Description of dependency" name="depDescription[]"></textarea></td>
                                            <td><textarea placeholder="Impact description" name="depImpact[]"></textarea></td>
                                            <td><input type="text" placeholder="Contact info" name="depContact[]"></td>
                                            <td><button type="button" class="btn-remove" onclick="removeTableRow(this)">Remove</button></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <button type="button" class="btn-add" onclick="addDependencyRow()">Add Dependency</button>
                    </div>

                    <!-- Azure Integration Details -->
                    <div class="azure-integration">
                        <h3>Azure Integration Configuration</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="azureTenantId" style="color: white;">Azure Tenant ID</label>
                                <input type="text" id="azureTenantId" name="azureTenantId" placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx">
                            </div>
                            <div class="form-group">
                                <label for="aadConnectServer" style="color: white;">AAD Connect Server</label>
                                <input type="text" id="aadConnectServer" name="aadConnectServer" placeholder="Server FQDN">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="syncFrequency" style="color: white;">Sync Frequency</label>
                                <select id="syncFrequency" name="syncFrequency">
                                    <option value="">Select</option>
                                    <option value="30min">30 minutes</option>
                                    <option value="1hour">1 hour</option>
                                    <option value="2hours">2 hours</option>
                                    <option value="4hours">4 hours</option>
                                    <option value="custom">Custom</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="adfsEndpoint" style="color: white;">ADFS Endpoint</label>
                                <input type="text" id="adfsEndpoint" name="adfsEndpoint" placeholder="https://adfs.company.com">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Section C: Support Model -->
                <div class="section">
                    <h2>C. Support Model</h2>
                    
                    <!-- Support Tiers -->
                    <div class="form-group">
                        <label>Support Tier Responsibilities</label>
                        <div class="interactive-table">
                            <div class="table-container">
                                <table class="data-table" id="supportTierTable">
                                    <thead>
                                        <tr>
                                            <th>Support Tier</th>
                                            <th>Responsibilities</th>
                                            <th>Escalation Criteria</th>
                                            <th>Team/Contact</th>
                                            <th>SLA</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="supportTierTableBody">
                                        <tr>
                                            <td>
                                                <select name="tierLevel[]">
                                                    <option value="">Select</option>
                                                    <option value="tier1">Tier 1 - Help Desk</option>
                                                    <option value="tier2">Tier 2 - Technical</option>
                                                    <option value="tier3">Tier 3 - Specialist</option>
                                                    <option value="vendor">Vendor Support</option>
                                                </select>
                                            </td>
                                            <td><textarea placeholder="What this tier handles" name="tierResponsibilities[]"></textarea></td>
                                            <td><textarea placeholder="When to escalate" name="tierEscalation[]"></textarea></td>
                                            <td><input type="text" placeholder="Team/Contact info" name="tierContact[]"></td>
                                            <td><input type="text" placeholder="Response time" name="tierSLA[]"></td>
                                            <td><button type="button" class="btn-remove" onclick="removeTableRow(this)">Remove</button></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <button type="button" class="btn-add" onclick="addSupportTierRow()">Add Support Tier</button>
                    </div>

                    <!-- Contact List -->
                    <div class="form-group">
                        <label>Key Contact List</label>
                        <div class="interactive-table">
                            <div class="table-container">
                                <table class="data-table" id="contactTable">
                                    <thead>
                                        <tr>
                                            <th>Role/Specialty</th>
                                            <th>Name</th>
                                            <th>Email</th>
                                            <th>Phone</th>
                                            <th>Team</th>
                                            <th>Backup</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="contactTableBody">
                                        <tr>
                                            <td><input type="text" placeholder="e.g., AD Administrator" name="contactRole[]"></td>
                                            <td><input type="text" placeholder="Full name" name="contactName[]"></td>
                                            <td><input type="email" placeholder="email@company.com" name="contactEmail[]"></td>
                                            <td><input type="tel" placeholder="Phone number" name="contactPhone[]"></td>
                                            <td><input type="text" placeholder="Team/Department" name="contactTeam[]"></td>
                                            <td><input type="text" placeholder="Backup person" name="contactBackup[]"></td>
                                            <td><button type="button" class="btn-remove" onclick="removeTableRow(this)">Remove</button></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <button type="button" class="btn-add" onclick="addContactRow()">Add Contact</button>
                    </div>

                    <!-- Monitoring & Alerting -->
                    <div class="form-group">
                        <label>Monitoring & Alerting Configuration</label>
                        <div class="interactive-table">
                            <div class="table-container">
                                <table class="data-table" id="monitoringTable">
                                    <thead>
                                        <tr>
                                            <th>Monitor Type</th>
                                            <th>Tool/System</th>
                                            <th>Metric/Alert</th>
                                            <th>Threshold</th>
                                            <th>Severity</th>
                                            <th>Notification</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="monitoringTableBody">
                                        <tr>
                                            <td>
                                                <select name="monitorType[]">
                                                    <option value="">Select</option>
                                                    <option value="performance">Performance</option>
                                                    <option value="availability">Availability</option>
                                                    <option value="security">Security</option>
                                                    <option value="capacity">Capacity</option>
                                                    <option value="replication">Replication</option>
                                                    <option value="authentication">Authentication</option>
                                                </select>
                                            </td>
                                            <td><input type="text" placeholder="e.g., SCOM, Azure Monitor" name="monitorTool[]"></td>
                                            <td><input type="text" placeholder="e.g., CPU Usage, Service Down" name="monitorMetric[]"></td>
                                            <td><input type="text" placeholder="e.g., >80%, Service Unavailable" name="monitorThreshold[]"></td>
                                            <td>
                                                <select name="monitorSeverity[]">
                                                    <option value="">Select</option>
                                                    <option value="critical">Critical</option>
                                                    <option value="high">High</option>
                                                    <option value="medium">Medium</option>
                                                    <option value="low">Low</option>
                                                    <option value="info">Informational</option>
                                                </select>
                                            </td>
                                            <td><input type="text" placeholder="Email, SMS, Teams" name="monitorNotification[]"></td>
                                            <td><button type="button" class="btn-remove" onclick="removeTableRow(this)">Remove</button></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <button type="button" class="btn-add" onclick="addMonitoringRow()">Add Monitoring Rule</button>
                    </div>
                </div>

                <!-- Section D: Key Operational Procedures -->
                <div class="section">
                    <h2>D. Key Operational Procedures (Runbook References)</h2>
                    
                    <div class="form-group">
                        <label>Operational Runbook Catalog</label>
                        <div class="interactive-table">
                            <div class="table-container">
                                <table class="data-table" id="runbookTable">
                                    <thead>
                                        <tr>
                                            <th>Procedure Category</th>
                                            <th>Procedure Name</th>
                                            <th>Runbook ID</th>
                                            <th>Document Location</th>
                                            <th>Frequency</th>
                                            <th>Owner</th>
                                            <th>Last Updated</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="runbookTableBody">
                                        <tr>
                                            <td>
                                                <select name="runbookCategory[]">
                                                    <option value="">Select</option>
                                                    <option value="user-management">User Management</option>
                                                    <option value="group-management">Group Management</option>
                                                    <option value="password-reset">Password Reset</option>
                                                    <option value="backup-recovery">Backup & Recovery</option>
                                                    <option value="replication">Replication Issues</option>
                                                    <option value="security">Security Incidents</option>
                                                    <option value="maintenance">Maintenance</option>
                                                    <option value="monitoring">Monitoring</option>
                                                    <option value="troubleshooting">Troubleshooting</option>
                                                </select>
                                            </td>
                                            <td><input type="text" placeholder="e.g., User Account Creation" name="runbookName[]"></td>
                                            <td><input type="text" placeholder="e.g., RB-AD-001" name="runbookId[]"></td>
                                            <td><input type="text" placeholder="SharePoint/Wiki URL" name="runbookLocation[]"></td>
                                            <td>
                                                <select name="runbookFrequency[]">
                                                    <option value="">Select</option>
                                                    <option value="as-needed">As Needed</option>
                                                    <option value="daily">Daily</option>
                                                    <option value="weekly">Weekly</option>
                                                    <option value="monthly">Monthly</option>
                                                    <option value="quarterly">Quarterly</option>
                                                    <option value="annually">Annually</option>
                                                </select>
                                            </td>
                                            <td><input type="text" placeholder="Team/Person" name="runbookOwner[]"></td>
                                            <td><input type="date" name="runbookUpdated[]"></td>
                                            <td><button type="button" class="btn-remove" onclick="removeTableRow(this)">Remove</button></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <button type="button" class="btn-add" onclick="addRunbookRow()">Add Runbook Reference</button>
                    </div>
                </div>

                <!-- Section E: Disaster Recovery & Major Incident Response -->
                <div class="section">
                    <h2>E. Disaster Recovery & Major Incident Response</h2>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="rto">Recovery Time Objective (RTO)</label>
                            <input type="text" id="rto" name="rto" placeholder="e.g., 4 hours">
                        </div>
                        <div class="form-group">
                            <label for="rpo">Recovery Point Objective (RPO)</label>
                            <input type="text" id="rpo" name="rpo" placeholder="e.g., 15 minutes">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="recoverySteps">High-Level Recovery Steps</label>
                        <textarea id="recoverySteps" name="recoverySteps" class="textarea-large"
                                placeholder="Describe the strategic disaster recovery process for AD/Azure environment..."></textarea>
                    </div>

                    <div class="form-group">
                        <label for="backupStrategy">Backup Strategy & Testing</label>
                        <textarea id="backupStrategy" name="backupStrategy" class="textarea-large"
                                placeholder="Describe backup procedures, retention policies, and testing schedule..."></textarea>
                    </div>

                    <div class="form-group">
                        <label for="majorIncidentResponse">Major Incident Response Process</label>
                        <textarea id="majorIncidentResponse" name="majorIncidentResponse" class="textarea-large"
                                placeholder="Describe the process for handling major incidents affecting AD/Azure services..."></textarea>
                    </div>
                </div>

                <div class="download-options">
                    <button type="button" class="download-btn" onclick="generateDocxReport()">Download DOCX Report</button>
                    <button type="button" class="download-btn" onclick="generateHtmlReport()">Preview HTML Report</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        function showMessage(message, isError = false) {
            const statusEl = document.getElementById('statusMessage');
            const errorEl = document.getElementById('errorMessage');
            
            if (isError) {
                errorEl.textContent = message;
                errorEl.style.display = 'block';
                statusEl.style.display = 'none';
            } else {
                statusEl.textContent = message;
                statusEl.style.display = 'block';
                errorEl.style.display = 'none';
            }
            
            setTimeout(() => {
                statusEl.style.display = 'none';
                errorEl.style.display = 'none';
            }, 5000);
        }

        function removeTableRow(button) {
            const tableBody = button.closest('tbody');
            if (tableBody.rows.length > 1) {
                button.closest('tr').remove();
            } else {
                showMessage('Cannot remove the last row', true);
            }
        }

        // Table row addition functions
        function addSlaKpiRow() {
            const tbody = document.getElementById('slaKpiTableBody');
            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td><input type="text" placeholder="e.g., Authentication Response Time" name="slaMetric[]"></td>
                <td><input type="text" placeholder="e.g., <2 seconds" name="slaTarget[]"></td>
                <td><input type="text" placeholder="e.g., Azure Monitor" name="slaMeasurement[]"></td>
                <td>
                    <select name="slaFrequency[]">
                        <option value="">Select</option>
                        <option value="real-time">Real-time</option>
                        <option value="hourly">Hourly</option>
                        <option value="daily">Daily</option>
                        <option value="weekly">Weekly</option>
                        <option value="monthly">Monthly</option>
                    </select>
                </td>
                <td><input type="text" placeholder="Team/Person" name="slaOwner[]"></td>
                <td><button type="button" class="btn-remove" onclick="removeTableRow(this)">Remove</button></td>
            `;
            tbody.appendChild(newRow);
        }

        function addRaciRow() {
            const tbody = document.getElementById('raciTableBody');
            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td><input type="text" placeholder="e.g., Group Management" name="raciActivity[]"></td>
                <td><input type="text" placeholder="Person name" name="raciPerson[]"></td>
                <td>
                    <select name="raciRole[]">
                        <option value="">Select</option>
                        <option value="R">Responsible</option>
                        <option value="A">Accountable</option>
                        <option value="C">Consulted</option>
                        <option value="I">Informed</option>
                    </select>
                </td>
                <td><input type="text" placeholder="Contact info" name="raciContact[]"></td>
                <td><input type="text" placeholder="Backup person" name="raciBackup[]"></td>
                <td><button type="button" class="btn-remove" onclick="removeTableRow(this)">Remove</button></td>
            `;
            tbody.appendChild(newRow);
        }

        function addArchitectureRow() {
            const tbody = document.getElementById('architectureTableBody');
            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td>
                    <select name="archComponent[]">
                        <option value="">Select</option>
                        <option value="domain-controller">Domain Controller</option>
                        <option value="adfs">ADFS Server</option>
                        <option value="aad-connect">AAD Connect</option>
                        <option value="dns">DNS Server</option>
                        <option value="dhcp">DHCP Server</option>
                        <option value="ca">Certificate Authority</option>
                        <option value="nps">Network Policy Server</option>
                        <option value="other">Other</option>
                    </select>
                </td>
                <td><input type="text" placeholder="Server name" name="archServer[]"></td>
                <td><input type="text" placeholder="Primary/Secondary" name="archRole[]"></td>
                <td><input type="text" placeholder="IP or FQDN" name="archAddress[]"></td>
                <td><input type="text" placeholder="OS Version" name="archOS[]"></td>
                <td><input type="text" placeholder="Location" name="archLocation[]"></td>
                <td><button type="button" class="btn-remove" onclick="removeTableRow(this)">Remove</button></td>
            `;
            tbody.appendChild(newRow);
        }

        function addDependencyRow() {
            const tbody = document.getElementById('dependencyTableBody');
            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td>
                    <select name="depType[]">
                        <option value="">Select</option>
                        <option value="upstream">Upstream Dependency</option>
                        <option value="downstream">Downstream Consumer</option>
                        <option value="shared">Shared Service</option>
                        <option value="external">External Service</option>
                    </select>
                </td>
                <td><input type="text" placeholder="System name" name="depSystem[]"></td>
                <td><textarea placeholder="Description of dependency" name="depDescription[]"></textarea></td>
                <td><textarea placeholder="Impact description" name="depImpact[]"></textarea></td>
                <td><input type="text" placeholder="Contact info" name="depContact[]"></td>
                <td><button type="button" class="btn-remove" onclick="removeTableRow(this)">Remove</button></td>
            `;
            tbody.appendChild(newRow);
        }

        function addSupportTierRow() {
            const tbody = document.getElementById('supportTierTableBody');
            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td>
                    <select name="tierLevel[]">
                        <option value="">Select</option>
                        <option value="tier1">Tier 1 - Help Desk</option>
                        <option value="tier2">Tier 2 - Technical</option>
                        <option value="tier3">Tier 3 - Specialist</option>
                        <option value="vendor">Vendor Support</option>
                    </select>
                </td>
                <td><textarea placeholder="What this tier handles" name="tierResponsibilities[]"></textarea></td>
                <td><textarea placeholder="When to escalate" name="tierEscalation[]"></textarea></td>
                <td><input type="text" placeholder="Team/Contact info" name="tierContact[]"></td>
                <td><input type="text" placeholder="Response time" name="tierSLA[]"></td>
                <td><button type="button" class="btn-remove" onclick="removeTableRow(this)">Remove</button></td>
            `;
            tbody.appendChild(newRow);
        }

        function addContactRow() {
            const tbody = document.getElementById('contactTableBody');
            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td><input type="text" placeholder="e.g., AD Administrator" name="contactRole[]"></td>
                <td><input type="text" placeholder="Full name" name="contactName[]"></td>
                <td><input type="email" placeholder="email@company.com" name="contactEmail[]"></td>
                <td><input type="tel" placeholder="Phone number" name="contactPhone[]"></td>
                <td><input type="text" placeholder="Team/Department" name="contactTeam[]"></td>
                <td><input type="text" placeholder="Backup person" name="contactBackup[]"></td>
                <td><button type="button" class="btn-remove" onclick="removeTableRow(this)">Remove</button></td>
            `;
            tbody.appendChild(newRow);
        }

        function addMonitoringRow() {
            const tbody = document.getElementById('monitoringTableBody');
            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td>
                    <select name="monitorType[]">
                        <option value="">Select</option>
                        <option value="performance">Performance</option>
                        <option value="availability">Availability</option>
                        <option value="security">Security</option>
                        <option value="capacity">Capacity</option>
                        <option value="replication">Replication</option>
                        <option value="authentication">Authentication</option>
                    </select>
                </td>
                <td><input type="text" placeholder="e.g., SCOM, Azure Monitor" name="monitorTool[]"></td>
                <td><input type="text" placeholder="e.g., CPU Usage" name="monitorMetric[]"></td>
                <td><input type="text" placeholder="e.g., >80%" name="monitorThreshold[]"></td>
                <td>
                    <select name="monitorSeverity[]">
                        <option value="">Select</option>
                        <option value="critical">Critical</option>
                        <option value="high">High</option>
                        <option value="medium">Medium</option>
                        <option value="low">Low</option>
                        <option value="info">Informational</option>
                    </select>
                </td>
                <td><input type="text" placeholder="Email, SMS, Teams" name="monitorNotification[]"></td>
                <td><button type="button" class="btn-remove" onclick="removeTableRow(this)">Remove</button></td>
            `;
            tbody.appendChild(newRow);
        }

        function addRunbookRow() {
            const tbody = document.getElementById('runbookTableBody');
            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td>
                    <select name="runbookCategory[]">
                        <option value="">Select</option>
                        <option value="user-management">User Management</option>
                        <option value="group-management">Group Management</option>
                        <option value="password-reset">Password Reset</option>
                        <option value="backup-recovery">Backup & Recovery</option>
                        <option value="replication">Replication Issues</option>
                        <option value="security">Security Incidents</option>
                        <option value="maintenance">Maintenance</option>
                        <option value="monitoring">Monitoring</option>
                        <option value="troubleshooting">Troubleshooting</option>
                    </select>
                </td>
                <td><input type="text" placeholder="Procedure name" name="runbookName[]"></td>
                <td><input type="text" placeholder="e.g., RB-AD-002" name="runbookId[]"></td>
                <td><input type="text" placeholder="Document location" name="runbookLocation[]"></td>
                <td>
                    <select name="runbookFrequency[]">
                        <option value="">Select</option>
                        <option value="as-needed">As Needed</option>
                        <option value="daily">Daily</option>
                        <option value="weekly">Weekly</option>
                        <option value="monthly">Monthly</option>
                        <option value="quarterly">Quarterly</option>
                        <option value="annually">Annually</option>
                    </select>
                </td>
                <td><input type="text" placeholder="Owner" name="runbookOwner[]"></td>
                <td><input type="date" name="runbookUpdated[]"></td>
                <td><button type="button" class="btn-remove" onclick="removeTableRow(this)">Remove</button></td>
            `;
            tbody.appendChild(newRow);
        }

        function collectFormData() {
            const formData = new FormData(document.getElementById('t2rForm'));
            const data = {};
            
            // Basic fields
            for (let [key, value] of formData.entries()) {
                if (!key.includes('[]')) {
                    data[key] = value;
                }
            }
            
            // Collect table data
            data.slaKpi = collectTableData(['slaMetric', 'slaTarget', 'slaMeasurement', 'slaFrequency', 'slaOwner']);
            data.raci = collectTableData(['raciActivity', 'raciPerson', 'raciRole', 'raciContact', 'raciBackup']);
            data.architecture = collectTableData(['archComponent', 'archServer', 'archRole', 'archAddress', 'archOS', 'archLocation']);
            data.dependencies = collectTableData(['depType', 'depSystem', 'depDescription', 'depImpact', 'depContact']);
            data.supportTiers = collectTableData(['tierLevel', 'tierResponsibilities', 'tierEscalation', 'tierContact', 'tierSLA']);
            data.contacts = collectTableData(['contactRole', 'contactName', 'contactEmail', 'contactPhone', 'contactTeam', 'contactBackup']);
            data.monitoring = collectTableData(['monitorType', 'monitorTool', 'monitorMetric', 'monitorThreshold', 'monitorSeverity', 'monitorNotification']);
            data.runbooks = collectTableData(['runbookCategory', 'runbookName', 'runbookId', 'runbookLocation', 'runbookFrequency', 'runbookOwner', 'runbookUpdated']);
            
            return data;
        }

        function collectTableData(fieldNames) {
            const result = [];
            const firstField = document.querySelectorAll(`input[name="${fieldNames[0]}[]"], select[name="${fieldNames[0]}[]"], textarea[name="${fieldNames[0]}[]"]`);
            
            for (let i = 0; i < firstField.length; i++) {
                const row = {};
                let hasData = false;
                
                fieldNames.forEach(fieldName => {
                    const elements = document.querySelectorAll(`input[name="${fieldName}[]"], select[name="${fieldName}[]"], textarea[name="${fieldName}[]"]`);
                    if (elements[i]) {
                        const cleanFieldName = fieldName.replace(/([A-Z])/g, '_$1').toLowerCase();
                        row[cleanFieldName] = elements[i].value;
                        if (elements[i].value.trim()) hasData = true;
                    }
                });
                
                if (hasData) result.push(row);
            }
            
            return result;
        }

        function generateDocxReport() {
            try {
                if (typeof docx === 'undefined') {
                    showMessage('DOCX library not loaded. Please refresh the page and try again.', true);
                    return;
                }

                const data = collectFormData();
                
                if (!data.serviceName || !data.serviceDescription || !data.businessOwner || !data.technicalOwner) {
                    showMessage('Please fill in all required fields (marked with *)', true);
                    return;
                }

                showMessage('Generating comprehensive DOCX document...');
                
                const btn = event.target;
                const originalText = btn.textContent;
                btn.disabled = true;
                btn.textContent = 'Generating...';
                
                setTimeout(() => {
                    createComprehensiveDocx(data);
                    btn.disabled = false;
                    btn.textContent = originalText;
                }, 1000);
                
            } catch (error) {
                console.error('Error generating document:', error);
                showMessage('Error generating document: ' + error.message, true);
                
                if (event && event.target) {
                    event.target.disabled = false;
                    event.target.textContent = 'Download DOCX Report';
                }
            }
        }

        function createComprehensiveDocx(data) {
            try {
                console.log('Creating comprehensive DOCX document...', data);
                
                const currentDate = new Date().toLocaleDateString();
                
                // Create document with all sections
                const doc = new docx.Document({
                    creator: "AD/Azure T2R Generator",
                    title: `T2R - ${data.serviceName}`,
                    description: "Active Directory & Azure Transition to Runbook Document",
                    sections: [{
                        properties: {
                            page: {
                                margin: {
                                    top: 1440,
                                    right: 1440,
                                    bottom: 1440,
                                    left: 1440
                                }
                            }
                        },
                        children: [
                            // Title Page
                            new docx.Paragraph({
                                children: [
                                    new docx.TextRun({
                                        text: "Active Directory & Azure",
                                        bold: true,
                                        size: 32
                                    })
                                ],
                                alignment: docx.AlignmentType.CENTER,
                                spacing: { after: 200 }
                            }),
                            new docx.Paragraph({
                                children: [
                                    new docx.TextRun({
                                        text: "Transition to Runbook (T2R)",
                                        bold: true,
                                        size: 28,
                                        color: "0078D4"
                                    })
                                ],
                                alignment: docx.AlignmentType.CENTER,
                                spacing: { after: 400 }
                            }),
                            
                            new docx.Paragraph({
                                children: [
                                    new docx.TextRun({
                                        text: data.serviceName || "Service Name",
                                        bold: true,
                                        size: 36,
                                        color: "0078D4"
                                    })
                                ],
                                alignment: docx.AlignmentType.CENTER,
                                spacing: { after: 400 }
                            }),
                            
                            new docx.Paragraph({
                                children: [
                                    new docx.TextRun({
                                        text: `Generated on: ${currentDate}`,
                                        size: 20
                                    })
                                ],
                                alignment: docx.AlignmentType.CENTER,
                                spacing: { after: 800 }
                            }),

                            // Page Break
                            new docx.Paragraph({
                                text: "",
                                pageBreakBefore: true
                            }),

                            // Section A: Service Overview
                            new docx.Paragraph({
                                children: [
                                    new docx.TextRun({
                                        text: "A. Service Overview & Business Context",
                                        bold: true,
                                        size: 24,
                                        color: "0078D4"
                                    })
                                ],
                                spacing: { before: 400, after: 300 }
                            }),

                            // Service Information Table
                            createInfoTable([
                                ["Service Name", data.serviceName || "N/A"],
                                ["Service Version", data.serviceVersion || "N/A"],
                                ["Environment", data.environment || "N/A"],
                                ["User Count", data.userCount || "N/A"],
                                ["Business Owner", data.businessOwner || "N/A"],
                                ["Technical Owner", data.technicalOwner || "N/A"]
                            ]),

                            new docx.Paragraph({
                                children: [
                                    new docx.TextRun({
                                        text: "Service Description:",
                                        bold: true,
                                        size: 16
                                    })
                                ],
                                spacing: { before: 300, after: 150 }
                            }),

                            new docx.Paragraph({
                                children: [
                                    new docx.TextRun({
                                        text: data.serviceDescription || "No description provided"
                                    })
                                ],
                                spacing: { after: 300 }
                            }),

                            // SLA/KPI Section
                            new docx.Paragraph({
                                children: [
                                    new docx.TextRun({
                                        text: "SLAs & KPIs:",
                                        bold: true,
                                        size: 16
                                    })
                                ],
                                spacing: { before: 300, after: 150 }
                            }),

                            createDataTable(
                                ["Metric", "Target", "Measurement", "Frequency", "Owner"],
                                data.slaKpi || [],
                                ['sla_metric', 'sla_target', 'sla_measurement', 'sla_frequency', 'sla_owner']
                            ),

                            // RACI Matrix
                            new docx.Paragraph({
                                children: [
                                    new docx.TextRun({
                                        text: "RACI Matrix:",
                                        bold: true,
                                        size: 16
                                    })
                                ],
                                spacing: { before: 400, after: 150 }
                            }),

                            createDataTable(
                                ["Activity", "Person", "Role", "Contact", "Backup"],
                                data.raci || [],
                                ['raci_activity', 'raci_person', 'raci_role', 'raci_contact', 'raci_backup']
                            ),

                            // Section B: Architectural Overview
                            new docx.Paragraph({
                                children: [
                                    new docx.TextRun({
                                        text: "B. Architectural Overview",
                                        bold: true,
                                        size: 24,
                                        color: "0078D4"
                                    })
                                ],
                                spacing: { before: 600, after: 300 }
                            }),

                            new docx.Paragraph({
                                children: [
                                    new docx.TextRun({
                                        text: "System Architecture:",
                                        bold: true,
                                        size: 16
                                    })
                                ],
                                spacing: { after: 150 }
                            }),

                            createDataTable(
                                ["Component", "Server", "Role", "Address", "OS", "Location"],
                                data.architecture || [],
                                ['arch_component', 'arch_server', 'arch_role', 'arch_address', 'arch_o_s', 'arch_location']
                            ),

                            new docx.Paragraph({
                                children: [
                                    new docx.TextRun({
                                        text: "System Dependencies:",
                                        bold: true,
                                        size: 16
                                    })
                                ],
                                spacing: { before: 400, after: 150 }
                            }),

                            createDataTable(
                                ["Type", "System", "Description", "Impact", "Contact"],
                                data.dependencies || [],
                                ['dep_type', 'dep_system', 'dep_description', 'dep_impact', 'dep_contact']
                            ),

                            // Azure Integration
                            new docx.Paragraph({
                                children: [
                                    new docx.TextRun({
                                        text: "Azure Integration:",
                                        bold: true,
                                        size: 16
                                    })
                                ],
                                spacing: { before: 400, after: 150 }
                            }),

                            createInfoTable([
                                ["Azure Tenant ID", data.azureTenantId || "N/A"],
                                ["AAD Connect Server", data.aadConnectServer || "N/A"],
                                ["Sync Frequency", data.syncFrequency || "N/A"],
                                ["ADFS Endpoint", data.adfsEndpoint || "N/A"]
                            ]),

                            // Section C: Support Model
                            new docx.Paragraph({
                                children: [
                                    new docx.TextRun({
                                        text: "C. Support Model",
                                        bold: true,
                                        size: 24,
                                        color: "0078D4"
                                    })
                                ],
                                spacing: { before: 600, after: 300 }
                            }),

                            new docx.Paragraph({
                                children: [
                                    new docx.TextRun({
                                        text: "Support Tiers:",
                                        bold: true,
                                        size: 16
                                    })
                                ],
                                spacing: { after: 150 }
                            }),

                            createDataTable(
                                ["Tier", "Responsibilities", "Escalation", "Contact", "SLA"],
                                data.supportTiers || [],
                                ['tier_level', 'tier_responsibilities', 'tier_escalation', 'tier_contact', 'tier_s_l_a']
                            ),

                            new docx.Paragraph({
                                children: [
                                    new docx.TextRun({
                                        text: "Key Contacts:",
                                        bold: true,
                                        size: 16
                                    })
                                ],
                                spacing: { before: 400, after: 150 }
                            }),

                            createDataTable(
                                ["Role", "Name", "Email", "Phone", "Team", "Backup"],
                                data.contacts || [],
                                ['contact_role', 'contact_name', 'contact_email', 'contact_phone', 'contact_team', 'contact_backup']
                            ),

                            new docx.Paragraph({
                                children: [
                                    new docx.TextRun({
                                        text: "Monitoring & Alerting:",
                                        bold: true,
                                        size: 16
                                    })
                                ],
                                spacing: { before: 400, after: 150 }
                            }),

                            createDataTable(
                                ["Type", "Tool", "Metric", "Threshold", "Severity", "Notification"],
                                data.monitoring || [],
                                ['monitor_type', 'monitor_tool', 'monitor_metric', 'monitor_threshold', 'monitor_severity', 'monitor_notification']
                            ),

                            // Section D: Operational Procedures
                            new docx.Paragraph({
                                children: [
                                    new docx.TextRun({
                                        text: "D. Key Operational Procedures",
                                        bold: true,
                                        size: 24,
                                        color: "0078D4"
                                    })
                                ],
                                spacing: { before: 600, after: 300 }
                            }),

                            new docx.Paragraph({
                                children: [
                                    new docx.TextRun({
                                        text: "Runbook Catalog:",
                                        bold: true,
                                        size: 16
                                    })
                                ],
                                spacing: { after: 150 }
                            }),

                            createDataTable(
                                ["Category", "Procedure", "ID", "Location", "Frequency", "Owner", "Updated"],
                                data.runbooks || [],
                                ['runbook_category', 'runbook_name', 'runbook_id', 'runbook_location', 'runbook_frequency', 'runbook_owner', 'runbook_updated']
                            ),

                            // Section E: Disaster Recovery
                            new docx.Paragraph({
                                children: [
                                    new docx.TextRun({
                                        text: "E. Disaster Recovery & Major Incident Response",
                                        bold: true,
                                        size: 24,
                                        color: "0078D4"
                                    })
                                ],
                                spacing: { before: 600, after: 300 }
                            }),

                            createInfoTable([
                                ["Recovery Time Objective (RTO)", data.rto || "N/A"],
                                ["Recovery Point Objective (RPO)", data.rpo || "N/A"]
                            ]),

                            new docx.Paragraph({
                                children: [
                                    new docx.TextRun({
                                        text: "Recovery Steps:",
                                        bold: true,
                                        size: 16
                                    })
                                ],
                                spacing: { before: 400, after: 150 }
                            }),

                            new docx.Paragraph({
                                children: [
                                    new docx.TextRun({
                                        text: data.recoverySteps || "No recovery steps specified"
                                    })
                                ],
                                spacing: { after: 300 }
                            }),

                            new docx.Paragraph({
                                children: [
                                    new docx.TextRun({
                                        text: "Backup Strategy:",
                                        bold: true,
                                        size: 16
                                    })
                                ],
                                spacing: { before: 300, after: 150 }
                            }),

                            new docx.Paragraph({
                                children: [
                                    new docx.TextRun({
                                        text: data.backupStrategy || "No backup strategy specified"
                                    })
                                ],
                                spacing: { after: 300 }
                            }),

                            new docx.Paragraph({
                                children: [
                                    new docx.TextRun({
                                        text: "Major Incident Response:",
                                        bold: true,
                                        size: 16
                                    })
                                ],
                                spacing: { before: 300, after: 150 }
                            }),

                            new docx.Paragraph({
                                children: [
                                    new docx.TextRun({
                                        text: data.majorIncidentResponse || "No major incident response process specified"
                                    })
                                ],
                                spacing: { after: 400 }
                            })
                        ]
                    }]
                });

                // Helper functions
                function createInfoTable(rows) {
                    const tableRows = rows.map(([label, value]) => 
                        new docx.TableRow({
                            children: [
                                new docx.TableCell({
                                    children: [new docx.Paragraph({
                                        children: [new docx.TextRun({ text: label, bold: true })]
                                    })],
                                    width: { size: 30, type: docx.WidthType.PERCENTAGE },
                                    shading: { fill: "F8F9FA" }
                                }),
                                new docx.TableCell({
                                    children: [new docx.Paragraph({
                                        children: [new docx.TextRun({ text: value || "N/A" })]
                                    })],
                                    width: { size: 70, type: docx.WidthType.PERCENTAGE }
                                })
                            ]
                        })
                    );

                    return new docx.Table({
                        width: { size: 100, type: docx.WidthType.PERCENTAGE },
                        rows: tableRows
                    });
                }

                function createDataTable(headers, data, fields) {
                    if (!data || data.length === 0) {
                        return new docx.Paragraph({
                            children: [new docx.TextRun({ text: "No data specified for this section." })],
                            spacing: { after: 200 }
                        });
                    }

                    // Header row
                    const headerRow = new docx.TableRow({
                        children: headers.map(header => 
                            new docx.TableCell({
                                children: [new docx.Paragraph({
                                    children: [new docx.TextRun({ text: header, bold: true, color: "FFFFFF" })]
                                })],
                                shading: { fill: "0078D4" }
                            })
                        )
                    });

                    // Data rows
                    const dataRows = data.map(item => 
                        new docx.TableRow({
                            children: fields.map(field => 
                                new docx.TableCell({
                                    children: [new docx.Paragraph({
                                        children: [new docx.TextRun({ 
                                            text: item[field] || "N/A",
                                            size: 20
                                        })]
                                    })]
                                })
                            )
                        })
                    );

                    return new docx.Table({
                        width: { size: 100, type: docx.WidthType.PERCENTAGE },
                        rows: [headerRow, ...dataRows]
                    });
                }

                console.log('Document created, generating blob...');

                docx.Packer.toBlob(doc).then(blob => {
                    console.log('Blob generated successfully:', blob);
                    
                    const fileName = `AD_Azure_T2R_${data.serviceName.replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toISOString().split('T')[0]}.docx`;
                    saveAs(blob, fileName);
                    showMessage('Comprehensive DOCX T2R document generated and downloaded successfully!');
                    
                }).catch(error => {
                    console.error('Error creating blob:', error);
                    showMessage('Error creating DOCX file: ' + error.message, true);
                });

            } catch (error) {
                console.error("Detailed error in createComprehensiveDocx:", error);
                showMessage("Error creating comprehensive DOCX document: " + error.message, true);
            }
        }

        function generateHtmlReport() {
            try {
                const data = collectFormData();
                
                if (!data.serviceName || !data.serviceDescription || !data.businessOwner || !data.technicalOwner) {
                    showMessage('Please fill in all required fields (marked with *)', true);
                    return;
                }

                showMessage('Generating comprehensive HTML preview...');
                
                const htmlContent = createComprehensiveHtmlReport(data);
                const blob = new Blob([htmlContent], { type: 'text/html' });
                const fileName = `AD_Azure_T2R_${data.serviceName.replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toISOString().split('T')[0]}.html`;
                saveAs(blob, fileName);
                
                showMessage('Comprehensive HTML report generated and downloaded successfully!');
                
            } catch (error) {
                console.error('Error generating HTML report:', error);
                showMessage('Error generating HTML report: ' + error.message, true);
            }
        }

        function createComprehensiveHtmlReport(data) {
            const currentDate = new Date().toLocaleDateString();
            
            function createHtmlTable(headers, data, fields) {
                if (!data || data.length === 0) {
                    return '<p><em>No data specified for this section.</em></p>';
                }

                const headerRow = `<tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>`;
                const dataRows = data.map(item => 
                    `<tr>${fields.map(field => `<td>${item[field] || 'N/A'}</td>`).join('')}</tr>`
                ).join('');

                return `<table>${headerRow}${dataRows}</table>`;
            }

            return `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comprehensive T2R Report - ${data.serviceName || 'Service'}</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; line-height: 1.6; color: #333; }
        h1 { color: #0078d4; border-bottom: 3px solid #0078d4; padding-bottom: 10px; text-align: center; }
        h2 { color: #106ebe; margin-top: 40px; page-break-before: always; }
        h3 { color: #0078d4; margin-top: 25px; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; font-size: 14px; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; vertical-align: top; }
        th { background-color: #0078d4; color: white; font-weight: bold; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        .service-name { font-size: 2.5em; color: #0078d4; margin: 20px 0; text-align: center; }
        .date { color: #666; margin-bottom: 40px; text-align: center; }
        .info-table th { width: 30%; background-color: #f8f9fa; color: #333; }
        .section { margin: 40px 0; }
        .page-break { page-break-before: always; }
        @media print { 
            .page-break { page-break-before: always; }
            h2 { page-break-before: always; }
        }
    </style>
</head>
<body>
    <h1>Active Directory & Azure Transition to Runbook (T2R)</h1>
    <div class="service-name">${data.serviceName || 'Service Name'}</div>
    <div class="date">Generated on: ${currentDate}</div>

    <div class="section">
        <h2>A. Service Overview & Business Context</h2>
        
        <h3>Service Information</h3>
        <table class="info-table">
            <tr><th>Service Name</th><td>${data.serviceName || 'N/A'}</td></tr>
            <tr><th>Service Version</th><td>${data.serviceVersion || 'N/A'}</td></tr>
            <tr><th>Environment</th><td>${data.environment || 'N/A'}</td></tr>
            <tr><th>User Count</th><td>${data.userCount || 'N/A'}</td></tr>
            <tr><th>Business Owner</th><td>${data.businessOwner || 'N/A'}</td></tr>
            <tr><th>Technical Owner</th><td>${data.technicalOwner || 'N/A'}</td></tr>
        </table>

        <h3>Service Description</h3>
        <p>${data.serviceDescription || 'N/A'}</p>

        <h3>Service Level Agreements (SLAs) & Key Performance Indicators (KPIs)</h3>
        ${createHtmlTable(['Metric', 'Target', 'Measurement', 'Frequency', 'Owner'], data.slaKpi, ['sla_metric', 'sla_target', 'sla_measurement', 'sla_frequency', 'sla_owner'])}

        <h3>RACI Matrix</h3>
        ${createHtmlTable(['Activity', 'Person', 'Role', 'Contact', 'Backup'], data.raci, ['raci_activity', 'raci_person', 'raci_role', 'raci_contact', 'raci_backup'])}
        <p><em>RACI Legend: R = Responsible, A = Accountable, C = Consulted, I = Informed</em></p>
    </div>

    <div class="section page-break">
        <h2>B. Architectural Overview</h2>

        <h3>High-Level Architecture Components</h3>
        ${createHtmlTable(['Component', 'Server', 'Role', 'Address', 'OS', 'Location'], data.architecture, ['arch_component', 'arch_server', 'arch_role', 'arch_address', 'arch_o_s', 'arch_location'])}

        <h3>System Dependencies</h3>
        ${createHtmlTable(['Type', 'System', 'Description', 'Impact', 'Contact'], data.dependencies, ['dep_type', 'dep_system', 'dep_description', 'dep_impact', 'dep_contact'])}

        <h3>Azure Integration Configuration</h3>
        <table class="info-table">
            <tr><th>Azure Tenant ID</th><td>${data.azureTenantId || 'N/A'}</td></tr>
            <tr><th>AAD Connect Server</th><td>${data.aadConnectServer || 'N/A'}</td></tr>
            <tr><th>Sync Frequency</th><td>${data.syncFrequency || 'N/A'}</td></tr>
            <tr><th>ADFS Endpoint</th><td>${data.adfsEndpoint || 'N/A'}</td></tr>
        </table>
    </div>

    <div class="section page-break">
        <h2>C. Support Model</h2>

        <h3>Support Tier Responsibilities</h3>
        ${createHtmlTable(['Tier', 'Responsibilities', 'Escalation', 'Contact', 'SLA'], data.supportTiers, ['tier_level', 'tier_responsibilities', 'tier_escalation', 'tier_contact', 'tier_s_l_a'])}

        <h3>Key Contact List</h3>
        ${createHtmlTable(['Role', 'Name', 'Email', 'Phone', 'Team', 'Backup'], data.contacts, ['contact_role', 'contact_name', 'contact_email', 'contact_phone', 'contact_team', 'contact_backup'])}

        <h3>Monitoring & Alerting Configuration</h3>
        ${createHtmlTable(['Type', 'Tool', 'Metric', 'Threshold', 'Severity', 'Notification'], data.monitoring, ['monitor_type', 'monitor_tool', 'monitor_metric', 'monitor_threshold', 'monitor_severity', 'monitor_notification'])}
    </div>

    <div class="section page-break">
        <h2>D. Key Operational Procedures</h2>

        <h3>Runbook Catalog (References to Detailed Procedures)</h3>
        ${createHtmlTable(['Category', 'Procedure', 'Runbook ID', 'Location', 'Frequency', 'Owner', 'Updated'], data.runbooks, ['runbook_category', 'runbook_name', 'runbook_id', 'runbook_location', 'runbook_frequency', 'runbook_owner', 'runbook_updated'])}
        <p><em>Note: This catalog references detailed runbooks and playbooks stored in the specified locations.</em></p>
    </div>

    <div class="section page-break">
        <h2>E. Disaster Recovery & Major Incident Response</h2>

        <h3>Recovery Objectives</h3>
        <table class="info-table">
            <tr><th>Recovery Time Objective (RTO)</th><td>${data.rto || 'N/A'}</td></tr>
            <tr><th>Recovery Point Objective (RPO)</th><td>${data.rpo || 'N/A'}</td></tr>
        </table>

        <h3>High-Level Recovery Steps</h3>
        <p>${data.recoverySteps || 'No recovery steps specified.'}</p>

        <h3>Backup Strategy & Testing</h3>
        <p>${data.backupStrategy || 'No backup strategy specified.'}</p>

        <h3>Major Incident Response Process</h3>
        <p>${data.majorIncidentResponse || 'No major incident response process specified.'}</p>
    </div>

    <div style="margin-top: 60px; padding-top: 20px; border-top: 2px solid #0078d4;">
        <p><strong>Document Purpose:</strong> This T2R document captures the operational context and knowledge required for supporting the ${data.serviceName || 'service'}. It serves as the foundational guide for understanding what the operations team is now supporting and provides references to detailed operational procedures.</p>
    </div>

</body>
</html>`;
        }

        // Initialize with sample data for testing
        window.addEventListener('load', function() {
            document.getElementById('serviceName').value = 'Corporate Active Directory';
            document.getElementById('serviceDescription').value = 'Primary identity management system for corporate environment providing authentication and authorization services';
            document.getElementById('businessOwner').value = 'John Smith';
            document.getElementById('technicalOwner').value = 'Jane Doe';
            document.getElementById('environment').value = 'hybrid';
        });
    </script>
</body>
</html>